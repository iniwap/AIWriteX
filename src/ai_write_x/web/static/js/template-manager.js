class TemplateManager {  
    constructor() {  
        this.templates = [];  
        this.categories = [];  
        this.currentTemplate = null;  
        this.currentLayout = 'grid'; // 'grid' or 'list'  
        this.currentCategory = null;  
        this.init();  
    }  
  
    async init() {  
        await this.loadCategories();  
        await this.loadTemplates();  
        this.bindEvents();  
        this.renderCategoryTree();  
        this.renderTemplateGrid();  
    }  
  
    async loadCategories() {  
        const response = await fetch('/api/templates/categories');  
        const result = await response.json();  
        this.categories = result.data;  
    }  
  
    async loadTemplates(category = null) {  
        const url = category   
            ? `/api/templates?category=${encodeURIComponent(category)}`  
            : '/api/templates';  
        const response = await fetch(url);  
        const result = await response.json();  
        this.templates = result.data;  
    }  
  
    bindEvents() {  
        // Êñ∞Âª∫Ê®°Êùø  
        const addTemplateBtn = document.getElementById('add-template');  
        if (addTemplateBtn) {  
            addTemplateBtn.addEventListener('click', () => {  
                this.showCreateTemplateDialog();  
            });  
        }  
          
        // Êñ∞Âª∫ÂàÜÁ±ª  
        const addCategoryBtn = document.getElementById('add-category');  
        if (addCategoryBtn) {  
            addCategoryBtn.addEventListener('click', () => {  
                this.showCreateCategoryDialog();  
            });  
        }  
          
        // ÊêúÁ¥¢  
        const searchInput = document.getElementById('template-search');  
        if (searchInput) {  
            searchInput.addEventListener('input', (e) => {  
                this.filterTemplates(e.target.value);  
            });  
        }  
          
        // ËßÜÂõæÂàáÊç¢ - ‰ΩøÁî®Êõ¥ÂÖ∑‰ΩìÁöÑÈÄâÊã©Âô®ÈÅøÂÖçÂÜ≤Á™Å  
        document.querySelectorAll('.view-toggle .view-btn').forEach(btn => {  
            btn.addEventListener('click', (e) => {  
                e.preventDefault();  
                e.stopPropagation();  
                this.switchLayout(btn.dataset.layout);  
            });  
        });  
          
        // ÂàÜÁ±ªÊ†ëÁÇπÂáª  
        const categoryTree = document.getElementById('category-tree');  
        if (categoryTree) {  
            categoryTree.addEventListener('click', (e) => {  
                const categoryItem = e.target.closest('.category-item');  
                if (categoryItem) {  
                    this.selectCategory(categoryItem.dataset.category);  
                }  
            });  
        }  
    }  
  
    renderCategoryTree() {  
        const tree = document.getElementById('category-tree');  
        if (!tree) return;  
          
        const allCount = this.templates.length;  
        tree.innerHTML = `  
            <div class="category-item ${!this.currentCategory ? 'active' : ''}" data-category="">  
                <span class="category-icon">üìÅ</span>  
                <span class="category-name">ÂÖ®ÈÉ®Ê®°Êùø</span>  
                <span class="category-count">${allCount}</span>  
            </div>  
            ${this.categories.map(cat => `  
                <div class="category-item ${this.currentCategory === cat.name ? 'active' : ''}"   
                     data-category="${cat.name}">  
                    <span class="category-icon">üìÇ</span>  
                    <span class="category-name">${cat.name}</span>  
                    <span class="category-count">${cat.template_count}</span>  
                </div>  
            `).join('')}  
        `;  
    }  
  
    renderTemplateGrid() {  
        const grid = document.getElementById('template-grid');  
        if (!grid) return;  
          
        grid.className = this.currentLayout === 'grid' ? 'template-grid' : 'template-grid list-view';  
          
        if (this.templates.length === 0) {  
            grid.innerHTML = '<div class="empty-state">ÊöÇÊó†Ê®°Êùø</div>';  
            return;  
        }  
          
        // ÂÖàÊ∏≤ÊüìÂç°ÁâáÁªìÊûÑ  
        grid.innerHTML = this.templates.map(template => `  
            <div class="template-card" data-template-path="${template.path}">  
                <div class="card-preview">  
                    <iframe sandbox="allow-same-origin allow-scripts"   
                            loading="lazy"  
                            data-template-path="${template.path}"></iframe>  
                </div>    
                <div class="card-content">  
                    <h4 class="card-title">${template.name}</h4>  
                    <div class="card-meta">  
                        <span class="category-badge">${template.category}</span>  
                        <span class="size-info">${template.size}</span>  
                    </div>  
                </div>  
                <div class="card-actions">  
                    <button class="btn-icon" data-action="preview" title="È¢ÑËßà">  
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor">  
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>  
                            <circle cx="12" cy="12" r="3"/>  
                        </svg>  
                    </button>  
                    <button class="btn-icon" data-action="edit" title="ÁºñËæë">  
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor">  
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>  
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>  
                        </svg>  
                    </button>  
                    <button class="btn-icon" data-action="copy" title="Â§çÂà∂">  
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor">  
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>  
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>  
                        </svg>  
                    </button>  
                    <button class="btn-icon" data-action="delete" title="Âà†Èô§">  
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor">  
                            <polyline points="3 6 5 6 21 6"/>  
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>  
                        </svg>  
                    </button>  
                </div>  
            </div>  
        `).join('');  
          
        // ÂºÇÊ≠•Âä†ËΩΩÈ¢ÑËßàÂÜÖÂÆπ  
        this.loadPreviewContents();  
        this.bindCardEvents();  
    }  
      
    async loadPreviewContents() {  
        const iframes = document.querySelectorAll('.card-preview iframe[data-template-path]');  
        
        for (const iframe of iframes) {  
            const templatePath = iframe.dataset.templatePath;  
            try {  
                const response = await fetch(`/api/templates/content/${encodeURIComponent(templatePath)}`);  
                if (!response.ok) {  
                    throw new Error(`HTTP ${response.status}`);  
                }  
                const html = await response.text();  
                const styledHtml = `  
                    <style>  
                        body {   
                            overflow: hidden !important;   
                            margin: 0;  
                        }  
                        ::-webkit-scrollbar { display: none !important; }  
                        * { scrollbar-width: none !important; }  
                    </style>  
                    ${html}  
                `;  
                iframe.srcdoc = styledHtml;
            } catch (error) {  
                console.error('Âä†ËΩΩÊ®°ÊùøÈ¢ÑËßàÂ§±Ë¥•:', templatePath, error);  
                iframe.srcdoc = '<div style="padding: 20px; color: red;">Âä†ËΩΩÂ§±Ë¥•</div>';  
            }  
        }  
    }  
  
    bindCardEvents() {  
        const grid = document.getElementById('template-grid');  
        if (!grid) return;  
          
        grid.querySelectorAll('.template-card').forEach(card => {  
            // Âç°ÁâáÁÇπÂáªÈ¢ÑËßà  
            card.addEventListener('click', (e) => {  
                if (!e.target.closest('.card-actions')) {  
                    const templatePath = card.dataset.templatePath;  
                    const template = this.templates.find(t => t.path === templatePath);  
                    if (template) {  
                        this.previewTemplate(template);  
                    }  
                }  
            });  
              
            // Êìç‰ΩúÊåâÈíÆÁÇπÂáª  
            card.querySelectorAll('[data-action]').forEach(btn => {  
                btn.addEventListener('click', (e) => {  
                    e.stopPropagation();  
                    const action = btn.dataset.action;  
                    const templatePath = card.dataset.templatePath;  
                    const template = this.templates.find(t => t.path === templatePath);  
                    if (template) {  
                        this.handleCardAction(action, template);  
                    }  
                });  
            });  
        });  
    }  
  
    async handleCardAction(action, template) {  
        switch(action) {  
            case 'preview':  
                this.previewTemplate(template);  
                break;  
            case 'edit':  
                await this.editTemplate(template);  
                break;  
            case 'copy':  
                await this.copyTemplate(template);  
                break;  
            case 'delete':  
                await this.deleteTemplate(template);  
                break;  
        }  
    }  
  
    previewTemplate(template) {  
        // ‰ΩøÁî®ÂÖ®Â±Äpreview-panel,ÂèÇËÄÉÁé∞ÊúâÂÆûÁé∞  
        fetch(`/api/templates/content/${encodeURIComponent(template.path)}`)  
            .then(res => res.text())  
            .then(html => {  
                if (window.previewPanelManager) {  
                    window.previewPanelManager.show(html);  
                }  
            })  
            .catch(err => {  
                console.error('È¢ÑËßàÂ§±Ë¥•:', err);  
                alert('È¢ÑËßàÂ§±Ë¥•: ' + err.message);  
            });  
    }  
  
    async editTemplate(template) {  
        // ‰ΩøÁî®Monaco EditorÊàñÁÆÄÂçïÁöÑÊñáÊú¨ÁºñËæëÂô®  
        const content = await fetch(`/api/templates/content/${encodeURIComponent(template.path)}`)  
            .then(res => res.text());  
          
        // ÊòæÁ§∫ÁºñËæëÂØπËØùÊ°Ü  
        const newContent = prompt('ÁºñËæëÊ®°ÊùøÂÜÖÂÆπ:', content);  
        if (newContent !== null && newContent !== content) {  
            try {  
                const response = await fetch(`/api/templates/content/${encodeURIComponent(template.path)}`, {  
                    method: 'PUT',  
                    headers: { 'Content-Type': 'application/json' },  
                    body: JSON.stringify({ content: newContent })  
                });  
                  
                if (response.ok) {  
                    window.app?.showNotification('Ê®°ÊùøÂ∑≤‰øùÂ≠ò', 'success');  
                } else {  
                    const error = await response.json();  
                    alert('‰øùÂ≠òÂ§±Ë¥•: ' + error.detail);  
                }  
            } catch (error) {  
                alert('‰øùÂ≠òÂ§±Ë¥•: ' + error.message);  
            }  
        }  
    }  
  
    async copyTemplate(template) {  
        const newName = prompt('ËæìÂÖ•Êñ∞Ê®°ÊùøÂêçÁß∞:', template.name + '_copy');  
        if (!newName) return;  
  
        try {  
            const response = await fetch('/api/templates/copy', {  
                method: 'POST',  
                headers: { 'Content-Type': 'application/json' },  
                body: JSON.stringify({  
                    source_path: template.path,  
                    new_name: newName,  
                    target_category: template.category  
                })  
            });  
  
            if (response.ok) {  
                await this.loadTemplates(this.currentCategory);  
                this.renderTemplateGrid();  
                window.app?.showNotification('Ê®°ÊùøÂ∑≤Â§çÂà∂', 'success');  
            } else {  
                const error = await response.json();  
                alert('Â§çÂà∂Â§±Ë¥•: ' + error.detail);  
            }  
        } catch (error) {  
            alert('Â§çÂà∂Â§±Ë¥•: ' + error.message);  
        }  
    }  
  
    async deleteTemplate(template) {  
        if (!confirm(`Á°ÆËÆ§Âà†Èô§Ê®°Êùø"${template.name}"?`)) return;  
          
        try {  
            const response = await fetch(`/api/templates/${encodeURIComponent(template.path)}`, {  
                method: 'DELETE'  
            });  
              
            if (response.ok) {  
                await this.loadCategories();  
                await this.loadTemplates(this.currentCategory);  
                this.renderCategoryTree();  
                this.renderTemplateGrid();  
                window.app?.showNotification('Ê®°ÊùøÂ∑≤Âà†Èô§', 'success');  
            } else {  
                const error = await response.json();  
                alert('Âà†Èô§Â§±Ë¥•: ' + error.detail);  
            }  
        } catch (error) {  
            alert('Âà†Èô§Â§±Ë¥•: ' + error.message);  
        }  
    }  
  
    switchLayout(layout) {  
        this.currentLayout = layout;  
          
        // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ  
        document.querySelectorAll('.view-toggle .view-btn').forEach(btn => {  
            btn.classList.toggle('active', btn.dataset.layout === layout);  
        });  
          
        // ÈáçÊñ∞Ê∏≤Êüì  
        this.renderTemplateGrid();  
    }  
  
    async selectCategory(category) {  
        this.currentCategory = category || null;  
        await this.loadTemplates(this.currentCategory);  
        this.renderCategoryTree();  
        this.renderTemplateGrid();  
    }  
  
    filterTemplates(searchText) {  
        const filtered = this.templates.filter(template =>   
            template.name.toLowerCase().includes(searchText.toLowerCase())  
        );  
          
        const grid = document.getElementById('template-grid');  
        if (!grid) return;  
          
        // ‰∏¥Êó∂ÊõøÊç¢templatesËøõË°åÊ∏≤Êüì  
        const originalTemplates = this.templates;  
        this.templates = filtered;  
        this.renderTemplateGrid();  
        this.templates = originalTemplates;  
    }  
  
    async showCreateTemplateDialog() {  
        const name = prompt('ËæìÂÖ•Ê®°ÊùøÂêçÁß∞:');  
        if (!name) return;  
  
        const category = prompt('ËæìÂÖ•ÂàÜÁ±ªÂêçÁß∞:', this.currentCategory || '');  
        if (!category) return;  
  
        try {  
            const response = await fetch('/api/templates/', {  
                method: 'POST',  
                headers: { 'Content-Type': 'application/json' },  
                body: JSON.stringify({  
                    name: name,  
                    category: category,  
                    content: ''  
                })  
            });  
  
            if (response.ok) {  
                await this.loadCategories();  
                await this.loadTemplates(this.currentCategory);  
                this.renderCategoryTree();  
                this.renderTemplateGrid();  
                window.app?.showNotification('Ê®°ÊùøÂ∑≤ÂàõÂª∫', 'success');  
            } else {  
                const error = await response.json();  
                alert('ÂàõÂª∫Â§±Ë¥•: ' + error.detail);  
            }  
        } catch (error) {  
            alert('ÂàõÂª∫Â§±Ë¥•: ' + error.message);  
        }  
    }  
  
    async showCreateCategoryDialog() {  
        const name = prompt('ËæìÂÖ•ÂàÜÁ±ªÂêçÁß∞:');  
        if (!name) return;  
  
        try {  
            const response = await fetch('/api/templates/categories', {  
                method: 'POST',  
                headers: { 'Content-Type': 'application/json' },  
                body: JSON.stringify({ name: name })  
            });  
  
            if (response.ok) {  
                await this.loadCategories();  
                this.renderCategoryTree();  
                window.app?.showNotification('ÂàÜÁ±ªÂ∑≤ÂàõÂª∫', 'success');  
            } else {  
                const error = await response.json();  
                alert('ÂàõÂª∫Â§±Ë¥•: ' + error.detail);  
            }  
        } catch (error) {  
            alert('ÂàõÂª∫Â§±Ë¥•: ' + error.message);  
        }  
    }  
}  
  
// ÂàùÂßãÂåñ  
window.templateManager = new TemplateManager();